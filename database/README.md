# Database Setup and Management

This directory contains database-related scripts and configurations for the Fresh Kanban application.

## üîê Row Level Security (RLS) Setup

### Problem
If you're experiencing empty error objects `{}` when updating deals, or getting permission errors when creating/editing/deleting deals, you likely need to set up RLS policies.

### Solution
Run the RLS policies script to enable seamless CRUD operations:

#### Option 1: Supabase Dashboard
1. Go to your Supabase project dashboard
2. Navigate to **SQL Editor**
3. Copy and paste the contents of `setup-rls-policies.sql`
4. Click **Run** to execute the script

#### Option 2: Command Line (if you have psql)
```bash
psql "your-supabase-connection-string" -f database/setup-rls-policies.sql
```

### What the Script Does

The `setup-rls-policies.sql` script:

- ‚úÖ **Enables RLS** on the `deals` table
- ‚úÖ **Creates SELECT policy** - allows authenticated users to read all deals
- ‚úÖ **Creates INSERT policy** - allows authenticated users to create new deals  
- ‚úÖ **Creates UPDATE policy** - allows authenticated users to edit existing deals
- ‚úÖ **Creates DELETE policy** - allows authenticated users to delete deals
- ‚úÖ **Grants table permissions** to authenticated role
- ‚úÖ **Includes verification queries** to confirm policies are working

### After Running the Script

1. **Test deal creation** - try adding a new deal in the frontend
2. **Test deal updates** - try changing a deal's status or other fields
3. **Test deal deletion** - try removing a deal
4. **Check console logs** - should now see detailed error messages instead of `{}`

### Verification

Run these queries in your Supabase SQL editor to verify the setup:

```sql
-- Check if RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'deals' AND schemaname = 'public';

-- List all policies
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'deals' AND schemaname = 'public';
```

## üóÇÔ∏è Migrations

The `migrations/` directory contains database schema migrations. These are typically auto-generated by your ORM or database migration tool.

## üö® Troubleshooting

### Still Getting Permission Errors?

1. **Check authentication** - ensure users are properly authenticated
2. **Check user roles** - verify the user has the `authenticated` role
3. **Check table structure** - ensure the `deals` table exists with expected columns
4. **Review console logs** - with enhanced error logging, you should see detailed error messages

### Need More Restrictive Policies?

The script includes commented examples for:
- User-specific access (users see only their own deals)
- Role-based permissions (only admins can delete)
- Field-level restrictions (prevent changes to certain columns)

Uncomment and modify these examples as needed for your security requirements.

## üìù Schema Notes

Based on the application code, the `deals` table should include these key columns:
- `deal_uuid` (primary key)
- `criado_em` (timestamp)
- `status_deal`, `nome_fundo`, `ticker_fundo`, `cnpj_fundo`, `gestora`
- `data_janela`, `data_dp`, `data_sobras`, etc. (date fields)
- `oferta_base`, `receita_potencial`, `volume_liquidado` (financial fields)
- `veiculo`, `produto`, `setor`, `tipo`, `principal_indexador` (categorization)
- `aprov_leitura`, `aprov_analise` (approval fields with S/N/TBD values)
- And many more fields as defined in `src/lib/types.ts`